-include files/$(THIS_FILE)/make.cfg
-include Makefile_flags

CC:=clang
ASM:=nasm

CC_INCLUDE:=-Ifiles -Ifiles/$(THIS_FILE)/include $(patsubst %,-Ifiles/%/include,$(LINK_AGAINST))

ASMFLAGS:=$(ASM_DEFAULT_FLAGS) $(ASM_EXTRA_FLAGS)
CFLAGS:=$(CC_REQUIRED_FLAGS) $(CC_OPTIONAL_FLAGS) $(CC_INCLUDE) $(CC_EXTRA_FLAGS)
LDFLAGS:=$(LD_DEFAULT_FLAGS) $(LD_EXTRA_FLAGS)

FILE_ASM:=$(wildcard files/$(THIS_FILE)/src/**/*.asm) $(wildcard files/$(THIS_FILE)/src/*.asm)
FILE_SRC:=$(wildcard files/$(THIS_FILE)/src/**/*.c) $(wildcard files/$(THIS_FILE)/src/*.c)
FILE_ASMOBJ:=$(patsubst files/$(THIS_FILE)/src/%.asm,tmp/$(THIS_FILE)/%.o,$(FILE_ASM))
FILE_OBJ:=$(patsubst files/$(THIS_FILE)/src/%.c,tmp/$(THIS_FILE)/%.o,$(FILE_SRC))

EXPORT_COMMAND:=cat files/$(THIS_FILE)/exports.h | grep -o -P '(?<= ).*(?=\()' | tr '\n' ' '
EXPORT_SYMBOLS:=$(shell $(EXPORT_COMMAND))

default: tmp/$(THIS_FILE).img

tmp/$(THIS_FILE):
	@mkdir $@

$(patsubst %,tmp/%.img.elf,$(LINK_AGAINST)) : % :
	@make $@ -f Makefile_template THIS_FILE=$(patsubst tmp/%.img.elf,%,$@) --no-print-directory
$(patsubst %,tmp/%.img,$(LINK_AGAINST)) : % :
	@make $@ -f Makefile_template THIS_FILE=$(patsubst tmp/%.img,%,$@) --no-print-directory


$(FILE_ASMOBJ) : tmp/$(THIS_FILE)/%.o : files/$(THIS_FILE)/src/%.asm
	$(ASM) $(ASMFLAGS) -o $@ $<

tmp/$(THIS_FILE)/obj.o : $(FILE_SRC)
	echo "$(patsubst %,#include \"../../%\"\n,$(FILE_SRC))" > tmp/$(THIS_FILE)/all.c
	$(CC) $(CFLAGS) -o tmp/$(THIS_FILE)/obj.o -c tmp/$(THIS_FILE)/all.c
#$(FILE_OBJ): tmp/$(THIS_FILE)/%.o : files/$(THIS_FILE)/src/%.c
#	$(CC) $(CFLAGS) -o $@ -c $<

tmp/$(THIS_FILE)/link.ld: link.ld
	@cp link.ld tmp/$(THIS_FILE)/link.c
	@$(CC) -E -P -o tmp/$(THIS_FILE)/link.ld tmp/$(THIS_FILE)/link.c -D MEM_OFFSET=$(MEM_OFFSET)

#tmp/$(THIS_FILE).img.elf: $(FILE_ASMOBJ) $(FILE_OBJ) tmp/$(THIS_FILE)/link.ld $(patsubst %,tmp/%.img.elf,$(LINK_AGAINST))
tmp/$(THIS_FILE).img.elf: $(FILE_ASMOBJ) tmp/$(THIS_FILE)/obj.o tmp/$(THIS_FILE)/link.ld $(patsubst %,tmp/%.img.elf,$(LINK_AGAINST))
	ld $(LDFLAGS) $(addprefix -u ,$(EXPORT_SYMBOLS)) $(addprefix -e ,$(ENTRY_SYMBOL)) $(patsubst %,-R tmp/%.img.elf,$(LINK_AGAINST)) \
	 	-T tmp/$(THIS_FILE)/link.ld -o tmp/$(THIS_FILE).img.elf $(FILE_ASMOBJ) tmp/$(THIS_FILE)/obj.o 
#	 	-T tmp/$(THIS_FILE)/link.ld -o tmp/$(THIS_FILE).img.elf $(FILE_ASMOBJ) $(FILE_OBJ) 

tmp/$(THIS_FILE).img: tmp/$(THIS_FILE).img.elf
	@objcopy -O binary tmp/$(THIS_FILE).img.elf tmp/$(THIS_FILE).img
